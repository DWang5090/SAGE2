<script src="processing-1.4.1.js"></script>
<script type="text/processing" data-processing-target="mycanvas">

String[] names; 
Neighborhood[] hoods;  
float globalMinLat, globalMaxLat, globalMinLon, globalMaxLon; 
Boolean overlay = true;

void setup(){
    sageBeforeSetup();
    
    //****YOUR SETUP CODE HERE****
    size(800, 800);

    readBoundaryData(); 

    //for( int i = 0; i < hoods.length; i++){
        //println("minLat: " + hoods[i].minLat + " maxLat: " 
        //    + hoods[i].maxLat + " minLon " + hoods[i].minLon + " maxLon " + hoods[i].maxLon );
    //}

    //if( overlay )
    //    readData("../../uploads/fake.chicagoMap");
        //readOverlayData(); 

    
    sageAfterSetup();
}

void draw(){

    sageBeforeDraw();
    
    if( goRedraw ){
    
        background(0);
        
         for( int i = 0; i < hoods.length; i++){
               hoods[i].drawNeighborhood();
         }

    }
    
    sageAfterDraw();
}

//************* YOUR FUNCTIONS HERE ********************//

void readBoundaryData(){

  String filename = "communityBoundaries.txt";
  String[] rows = loadStrings(filename); 


//String[] rows = {"1:NAME:87,47 94,79"};//split(theData, "\n");

  hoods = new Neighborhood[ rows.length ]; 
  for(int i = 0; i < rows.length; i++)
  {
    String[] tokens = split(rows[i], ":"); 
    hoods[i] = new Neighborhood( parseInt(tokens[0]), tokens[1] );
    
    String[] coordTokens = split(tokens[2], " ");
    hoods[i].setNumCoords( coordTokens.length);
    for(int j =0; j < coordTokens.length; j++){
      String[] coord = split(coordTokens[j], ","); 
      hoods[i].addCoord( parseFloat( coord[0]), parseFloat(coord[1]) );
    }
    

 }
 
    
 

}

void readData(String filename){
    readOverlayData(filename);
}

void readPipedData(String[] newData){
     for(int i =0 ; i<rows.length; i++){
        processStringForOverlay( rows[i] );
    }
}

void readOverlayData(String filename){
  
    String[] rows = loadStrings(filename); 

    
    for(int i =0 ; i<rows.length; i++){
        processStringForOverlay( rows[i] );
    }

 
}

void processStringForOverlay(String r){

    String[] tokens = split(r, ":" ); 
    int id = parseInt(tokens[0]);
    float value = parseFloat(tokens[1]);
    
    for(int i =0 ; i < hoods.length; i++){
        if(id == i){//hoods.idx){
            hoods[i].addDataValue(value);
            //hoods[i].theColor = color(255,255,0);
            break;
        }
    }
}

class Neighborhood{
  String name;
  int idx;
  PVector[] coords; 
  int coordCount;
  color theColor; 
  float[] dataValues;
  int numDataValues; 
  
  float minLat;
  float maxLat;
  float minLon;
  float maxLon; 
  
  float minX;
  float maxX;
  float minY;
  float maxY; 
  
  Neighborhood(int idx, String name){
    this.name = name;
    this.idx = idx;

    theColor = color( random(0, 255), random(0, 255), random(0, 255) );//color( idx*(name.length+2), idx*(name.length/2), idx*(name.length/3) );//random(0, 255), random(0, 255), random(0, 255) );
    
    minLat = 999999999999.0;
    minLon = 99999999999.0;
    maxLat = -999999999.0;
    maxLon = -99999999999.0;
    
    minX = 999999999999.0;
    minY = 99999999999.0;
    maxX = -999999999.0;
    maxY = -99999999999.0;
    
    dataValues = new float[1000]; 
    numDataValues = 0;
    
  }
  
  void setNumCoords(int num){
    coords = new PVector[num];
    coordCount = 0;
  }
  
  void addCoord(float lon, float lat){
     coords[coordCount] = new PVector( mapLon(lon), mapLat(lat) );
     coordCount ++; 
     
     if( lat < minLat ){
       minLat = lat;
       maxY = mapLat( minLat );
     }
     if( lon < minLon ){
       minLon = lon;
       minX = mapLon( minLon);
     }
     if( lat > maxLat ){
       maxLat = lat;
       minY = mapLat( maxLat);
     }
     if( lon > maxLon ){
       maxLon = lon; 
       maxX = mapLon( maxLon);
     }
  }
  
  void addDataValue(float value){
    dataValues[numDataValues] = value;
    numDataValues++;
    
    theColor = color(255, 0, 0);//mapDataToColor( value );
  }
  
  void drawNeighborhood(){
    if( coords.length == 0 )
      return; 
    
    fill( theColor);
    noStroke();
    if( mouseIsOver() ){
      fill( #FDCD4D);
    }

    beginShape(); 
    for(int i = 0; i < coords.length; i++)
    {
      //println(coords[i].x + " " + coords[i].y);
      if( i == 0  ) 
            curveVertex( coords[i].x, coords[i].y ); 

      curveVertex( coords[i].x, coords[i].y ); 
      
      if( i == coords.length-1 )
              curveVertex( coords[0].x, coords[0].y ); 

    }

    endShape(); 

  }
  
  //glitchy....
  //currently called when mouse pressed... 
  Boolean mouseIsOver(){
    float borderY = ( maxY-minY ) * .05;
    float borderX = ( maxX-minX ) * .05;
    if(  mouseY >= minY+borderY && mouseY <= maxY-borderY && mouseX >= minX+borderX && mouseX <= maxX-borderX )
      return true;
    return false;
  }
  
  float mapLat(float lat)
  {
    //println( "lat = " + lat + " mapped = " + map( lat, 41.3, 41.9, 0, height ) );
    return map( lat, 41.55, 42.05, height, 0 ); 
  }
  
  float mapLon(float lon)
  {
    return map( lon, -87.95, -87.45, 0, width) ;   
  }
}

color mapDataToColor(float data){
  if( data > 90.0 )
    return color(#B6564E);
   if( data > 80 )
     return color(#CD6A62);
   if( data > 70.0 )
     return color(#E1746B);
   if( data > 60.0 )
     return color(#ED776D);
   if( data > 50.0 )
     return color(#FD8279);
   if( data > 40.0 )
      return color(#FD948C); 
   if( data > 30.0 )
     return color(#FDA39C);
   if( data > 20.0 )
     return color(#FDB1AB);
   if( data > 10.0 )
     return color(#FFC8C4);
   return color(#FFDEDB); 
}

//************* END YOUR FUNCTIONS HERE ********************//

//************* MODIFY THESE FUNCTIONS TO PLAY ALONG WITH SAGE ********************//

void mousePressed(){
    //your mouse pressed handler here
    
}

void mouseDrag(){
    //your mouse drag handler here
}

void resizeSketch(int newWidth, int newHeight){
    size( newWidth, newHeight ); 
    
    //adjust sketch to new size....
    
}

void acceptSelectionEvents( String selectedId ){


}


//let sage know that an item has been selected 
void emitSelectionEvents( String selectedId ){
    
    
}


void sageBeforeSetup(){

}

void sageAfterSetup(){
    goRedraw = true;
}

void sageBeforeDraw(){
    if( pipedDataReady ){
        readPipedData( pipedData);
        goRedraw = true;
    }
    
    if( readyLoadData ){
        readData(filename);
        readyLoadData = false;
        goRedraw = true;
    }
    if( setMouseToPointer ){
        mouseX = pointerX;
        mouseY = pointerY;
        setMouseToPointer = false;

    }
    if( handlePointerPress ){
        //assume mouse already set to pointer, bc of flag... 
        mousePressed(); //call yourself
        
        //for debugging:
        sendMsg("pointer event at x= " + mouseX + " y= " + mouseY); 
        
        handlePointerPress = false; 
    }
    if( handleResize ){
        resizeSketch( newWidth, newHeight );
        handleResize = false; 
    }
}

void sageAfterDraw(){
    //sendMsg( "drawDone");   
    goRedraw = false; 
}

</script>
<canvas id="mycanvas"></canvas>
<script type="text/javascript" src="../../lib/socket.io.min.js"></script>
<script type="application/javascript">
var url;
var socket;

url = window.location.origin;  //works on desktop and thor
if( url.indexOf("iridium") >= 0 ) //iridium is special
    url = "10.0.8.100:9090";
socket = io.connect(url);
console.log("Connected to server: ", url);

//--------- LISTEN TO EVENTS FROM WEBSAGE---------------
//to do:  make this array of pointer objects... 
var pointerX = 0;
var pointerY = 0; 
var handlePointerPress = false; 
var pointerPressed = false; 
var goRedraw = false; 
var handleResize = false;
var newWidth = 0;
var newHeight =0;
var setMouseToPointer = false; 
var readyLoadData = false; 
var filename = "";
var pipedDataReady = false;
var pipedData = [];

window.addEventListener("message", receiveMessage, false);
function receiveMessage(event)
{
//   if (event.origin !== "http://example.org:8080")  //may add this later for security concerns
//     return;

//     if( event.data.indexOf('dataSend') != -1 ){
//         var tokens = event.data.split(' ');
//         inputData = tokens[1] ;
//     }
    if( event.data.indexOf( 'pointerCreated') != -1 ){
        //create pointer object
    }
    if (event.data.indexOf( 'pointerClick') != -1) {
        var tokens = event.data.split(' ');
        pointerX = tokens[2];
        pointerY = tokens[4]; 
        pointerPressed = true; 
        handlePointerPress = true;     
        goRedraw = true;   
        setMouseToPointer = true;
    }
    else if (event.data.indexOf( 'pointerMove') != -1) {
        var tokens = event.data.split(' ');
        pointerX = tokens[2];
        pointerY = tokens[4]; 
        goRedraw = true;     
        setMouseToPointer = true;
        if( pointerPressed ){
            //pointer drag
        }
    } 
    else if( event.data.indexOf( 'pointerReleased') != -1 ){
        pointerPressed = false; 
    }
    else if( event.data.indexOf( 'pointerScrolled' ) != -1){
        //handle scroll events
    }
    else if(event.data.indexOf('resize') != -1){
        var tokens = event.data.split(' ' ); 
        newWidth = tokens[2];
        newHeight = tokens[4]; 
        goRedraw = true;
        handleResize = true; 
    }
    else if( event.data.indexOf("loadData") != -1 ){
        var tokens = event.data.split(' ' ); 
        filename = tokens[2];
        readyLoadData = true;
        goRedraw = true;
    }
    else if(event.data.indexOf("newOverlayData") != -1){
        pipedData = event.data.split(' '); 
        
        pipedDataReady = true;
    }

}


//--------- SEND EVENTS TO WEBSAGE ---------------
function sendMsg(msg){
    
    socket.emit("eventInWindowRecorded", msg);
    
    //window.parent.postMessage('sendingMsg: ' + msg, '*');  
//     
//         pointerX = 800;
//         pointerY = 100; 
//         pointerPressed = true;     
//         readyRedraw = true;  
}

</script>

<!-- 

</script>
<canvas id="mycanvas"></canvas>

<script type="text/javascript" src="../../lib/socket.io.min.js"></script>
<script type="application/javascript">
var url;
var socket;

url = window.location.origin;
socket = io.connect(url);
console.log("Connected to server: ", url);

//~~~~~~~~- LISTEN TO EVENTS FROM WEBSAGE~~~~~~~~~~~~~~-
var pointerX = 0;
var pointerY = 0; 
var pointerPressed = false; 
var readyRedraw = false; 


window.addEventListener("message", receiveMessage, false);
function receiveMessage(event)
{
//   if (event.origin !== "http://example.org:8080")  //may add this later for security concerns
//     return;
    if (event.data.indexOf( 'pointerClick') != -1) {
        var tokens = event.data.split(' ');
        pointerX = tokens[2];
        pointerY = tokens[4]; 
        pointerPressed = true;     
        readyRedraw = true;     
    }
    if (event.data.indexOf( 'pointerMove') != -1) {
        var tokens = event.data.split(' ');
        pointerX = tokens[2];
        pointerY = tokens[4]; 
        readyRedraw = true;     
    } 

}


//~~~~~~~~- SEND EVENTS TO WEBSAGE ~~~~~~~~~~~~~~-
function sendMsg(msg){
    
    socket.emit("pointerEventRecorded", msg);
    //window.parent.postMessage('sendingMsg: ' + msg, '*');  

}

</script>
 -->