<script src="processing-1.4.1.js"></script>
<script type="text/processing" data-processing-target="mycanvas">

int windowWidth = 1080;
int windowHeight = 768; 

float[] data = {230.0, 40.0, 100.0, 130.0, 234.0, 129.0, 234.0, 700.0, 400.0, 500.0};
color[] colors = {#FC7878, #F25D8A, #F25DDF, #CF5DF2, #AC5DF2, #825DF2, #5D6AF2, #5DA1F2, #5DE2F2, #5DF2D5};
String[] labels = {"Theft", "Robbery", "Burglery", "Assault", "Drugs", "Dist The Peace", "Homicide", "Auto", "Prostitution", "Sexual Assault"}; 
Boolean[] drawDifferently;
Chart c; 

void setup(){
  size( windowWidth, windowHeight );
  readData("data.txt");
  c = new Chart( data, colors, labels ); 
  
  for(int i = 0; i < data.length; i++){
    drawDifferently = false; 
  }

}

void readData(String filename){    
    String[] rows = loadStrings(filename);
//    String[] columns = split(rows[0], ',');
    int rowCount = 0;
      // start reading at row 1, because the first row was only the column headers
    for (int i = 0; i < rows.length; i++) {
      if (trim(rows[i]).length() == 0) {
        continue; // skip empty rows
      }
      if (rows[i].startsWith("#")) {
        continue;  // skip comment lines
      }

      // split the row on the commas
      String[] pieces = split(rows[i], ',');
//
      
      // copy data into the table starting at pieces[1]
      data[rowCount] = parseFloat(pieces[1]); //parseFloat(subset(pieces, 1));
      labels[rowCount] = pieces[0];
      
      print(data[rowCount] + " " + labels[rowCount]);

      // increment the number of valid rows found so far
      rowCount++;      
    }
}


void draw(){
  background(0);
  
  c.drawChart();
 
}


public class Chart{
  
  float[] values; 
  float maxValue = 0; 
  
  Chart(float[] values , color[] colors, String[] labels){
    this.values = values;
    textAlign(CENTER);

    for(int i = 0; i <values.length; i++)
    {
      if( values[i] > maxValue)
        maxValue = values[i]; 

    }
  }
  
  void drawChart(){
  
      if( goSyncColor ){
        colors = new color[values.length]; 
        for(int i = 1; i < colorSyncTokens.length; i+=4){
            var id = parseInt(colorSyncTokens[i]);
            var r = parseInt(colorSyncTokens[i+1]);
            var g = parseInt(colorSyncTokens[i+2]);
            var b = parseInt(colorSyncTokens[i+3] );
            colors[id] = color(r,g,b);  //.push( color( r, g, b ) );
            //console.log( id + " " + r + " " + g + " " + b )
            //for(int j = 0 ; j < hoods.length; j++){
               //if( parseInt( hoods[j].name ) == id ){
                    //hoods[j].theColor = color(r, g, b );
                 //   break;
                //}
            //}
        }

       goSynColor = false;
    }
  
  
    rectMode(CORNERS);
    float startX = 100; 
    float endX = width-10;
    
    float gap = (endX-startX)*.005; 
    float div = (endX-startX-gap*(values.length+2))/values.length; 
    if( div > (endX-startX)*.1 )
      div = (endX-startX)*.1;
    if( gap > div )
      gap = div*.1;
    float runningX = startX+gap; 
    for(int i =0; i < values.length; i++)
    {
    
        if( !drawDifferently[1] )
            fill(colors[i%10]);
        else{
            fill(#FFE45D);
        }
        noStroke();
        float y2 = map( values[i], 0, maxValue, height-110, 10 );
        rect( runningX, height-100, runningX+(div), y2); 
        fill(255.0);
        stroke(255.0);
        pushMatrix(); 
        translate( runningX+div/2,height-55);//-1* ((int)runningX+(int)div/2), -1*(int)height-55); 
        rotate(radians(360.0-45.0)); 
        text(labels[i], 0, 0); //runningX+div/2, height-55 );
        popMatrix();
        
        if( mouseX > runningX && mouseX < runningX+div+gap){
            text(data[i], runningX+div/2, y2-15);
        }

        
        runningX = runningX + div + gap;
        
    }
    
  }
  
  void mousePressed(){
    mousePress = true;
<!-- 
     for(int i =0; i < values.length; i++)
    {
    
        if( mouseX > runningX && mouseX < runningX+div+gap){
            drawDifferently[i] = !drawDifferently[i];
        }
        
    }
 -->
  }
  
}



</script>
<canvas id="mycanvas"></canvas>
<script type="text/javascript" src="../../lib/socket.io.min.js"></script>
<script type="application/javascript">

var url;
var socket;

url = window.location.origin;  //works on desktop and thor
if( url.indexOf("iridium") >= 0 ) //iridium is special
    url = "10.0.8.100:9090";
socket = io.connect(url);
console.log("Connected to server: ", url);

var pointerX = 0;
var pointerY = 0; 
var pointerPressed = false; 
var readyRedraw = false; 
var theNewTags = [];
var newRed = 0;
var newBlue = 0;
var newGreen = 0;
var colorSyncId = 0;
var goSyncColor = false;

var colorSyncTokens = [];

window.addEventListener("message", receiveMessage, false);
function receiveMessage(event)
{
//window.onmessage = function(e){
    if (event.data.indexOf( 'pointerClick') != -1) {
        var tokens = e.data.split(' ');
        pointerX = tokens[2];
        pointerY = tokens[4]; 
        pointerPressed = true;     
        readyRedraw = true;     
    }
    if (event.data.indexOf( 'pointerMove') != -1) {
        var tokens = e.data.split(' ');
        pointerX = tokens[2];
        pointerY = tokens[4]; 
        readyRedraw = true;     
    } 
    if (event.data.indexOf("color") != -1 ){
         colorSyncTokens = event.data.split(' ' );
         console.log("sync!  " + event.data);
//         for(int i = 0; i < tokens.size; i++){
//             
//         }
//         newRed = parseInt(tokens[2]);
//         newGreen = parseInt(tokens[3]);
//         newBlue = parseInt(tokens[4]);
//         colorSyncId = parseInt(tokens[1]); 
//         
//         console.log("color sync id = " + colorSyncId);
        goSyncColor = true;
    }
    
    
};
//--------- SEND EVENTS TO WEBSAGE ---------------
function sendMsg(msg){
    
    socket.emit("eventInWindowRecorded", (msg+" id " + itemId) );
    
    //window.parent.postMessage('sendingMsg: ' + msg, '*');  
//     
//         pointerX = 800;
//         pointerY = 100; 
//         pointerPressed = true;     
//         readyRedraw = true;  
}


</script>