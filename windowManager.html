<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-,8">
<title>Window Manager</title>
<script type="text/javascript" src="lib/socket.io.min.js"></script>
<script type="text/javascript" src="scripts/windowManager.js"></script>
<script type="text/javascript">
	var url;
	var socket;
	var winMgr;
	
	function init() {
		url = window.location.origin;
		socket = io.connect(url);
		console.log("Connected to server: ", url);
		
		var fileDrop = document.getElementById("fileDrop");
		fileDrop.addEventListener('dragover', preventFileOpen, false);
		fileDrop.addEventListener('dragend', preventFileOpen, false);
		fileDrop.addEventListener('drop', uploadFileToServer, false);
		
		window.addEventListener('dragover', preventFileOpen, false);
		window.addEventListener('dragend', preventFileOpen, false);
		window.addEventListener('drop', preventFileOpen, false);
		
		winMgr = new windowManager('winMgr', socket);
		winMgr.draw();
		
		socket.on('setupDisplayConfiguration', function(config) {
			winMgr.initDisplayConfig(config);
		});
		
		socket.on('addNewElement', function(elem_data) {
			winMgr.addNewElement(elem_data);
		});
		
		socket.on('deleteElement', function(elemId) {
			winMgr.deleteElement(elemId);
		});
		
		socket.on('updateItemOrder', function(idList) {
			winMgr.updateItemOrder(idList);
		});
		
		socket.on('setItemPosition', function(position_data) {
			winMgr.setItemPosition(position_data);
		});
		
		socket.on('setItemPositionAndSize', function(position_data) {
			winMgr.setItemPositionAndSize(position_data);
		});
	}
	
	function preventFileOpen(event) {
		event.preventDefault();
	}
	
	function uploadFileToServer(event) {
		var i;
		event.preventDefault();
		
		var files = event.dataTransfer.files;
		var url = event.dataTransfer.getData("Url");
		var text = event.dataTransfer.getData("Text");
		if(files.length > 0){
			var formdata = new FormData();
			for(i=0; i<files.length; i++){
				formdata.append("file"+i.toString(), files[i]);
			}
			xhr = new XMLHttpRequest();
			xhr.open("POST", "/upload", true);
			xhr.upload.addEventListener('progress', function(event) {
				var fileDropText = document.getElementById("fileDropText");
				var pc = parseInt((event.loaded / event.total) * 100);
				fileDropText.innerHTML = "File upload... " + pc.toString() + "%";
				if(pc == 100){
					setTimeout(function() {
						fileDropText.innerHTML = "Drag files here to upload";
					}, 500);
				}
			}, false);
			xhr.send(formdata);
		}
		else if(url != null || text != null){
			var dataUrl = (url.length > text.length) ? url : text;
			var urlType = "";
			var youtube = dataUrl.indexOf("www.youtube.com");
			var ext = dataUrl.substring(dataUrl.lastIndexOf('.')+1);
			if(ext.length > 3) ext = ext.substring(0,3);
			if(youtube >= 0) urlType = "youtube";
			else if(ext == "jpg" || ext == "png" || ext == "bmp") urlType = "img";
			console.log("URL: " + dataUrl + ", type: " + urlType);
			socket.emit('addNewWebElement', {type: urlType, src: dataUrl});
		}
	}
	
</script>

<link rel="stylesheet" type="text/css" href="style_mgr.css" media="screen" />

</head>

<body onload="init()" onresize="winMgr.resize()">
	<div id="wrapper">
		<div id="window">
			<canvas id="winMgr" style="width: 80%;">HTML5 canvas element not supported</canvas>
		</div>
		<div id="fileDrop">
			<p id="fileDropText">Drag files here to upload</p>
		</div>
	</div>
</body>
</html>

