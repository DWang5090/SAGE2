<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-,8">
<title>Window Manager</title>
<script type="text/javascript" src="lib/socket.io.min.js"></script>
<script type="text/javascript" src="scripts/firebase.js"></script>
<script type="text/javascript" src="scripts/RTCMultiConnection-v1.5.js"></script>
<script type="text/javascript" src="scripts/windowManager.js"></script>
<script type="text/javascript">
	var url;
	var wmSocket;
	var winMgr;
	
	var canvasKeyEvents = false;
	var canvasKeyFunc = null;
	
	var name = "Default";
	var col = [180, 180, 180];
	
	var sensitivity;
	
	var selectedFile = null;
	
	var channelId;
	var roomId;
	var connection;
	
	function init() {
		url = window.location.origin;
		wmSocket = io.connect(url);
		console.log("Connected to server: ", url);
		
		document.addEventListener('pointerlockchange', pointerLockChange, false);
        document.addEventListener('mozpointerlockchange', pointerLockChange, false);
        document.addEventListener('webkitpointerlockchange', pointerLockChange, false);
		
		var fileDrop = document.getElementById("fileDrop");
		fileDrop.addEventListener('dragover', preventDefault, false);
		fileDrop.addEventListener('dragend', preventDefault, false);
		fileDrop.addEventListener('drop', uploadFileToServer, false);
		
		window.addEventListener('dragover', preventDefault, false);
		window.addEventListener('dragend', preventDefault, false);
		window.addEventListener('drop', preventDefault, false);
		
		var serverUploadBtn = document.getElementById("serverUploadBtn");
		var fileOKBtn = document.getElementById("fileOKBtn");
		var fileCloseBtn = document.getElementById("fileCloseBtn");
		serverUploadBtn.addEventListener('click', openServerFileBrowser, false);
		fileOKBtn.addEventListener('click', selectServerFiles, false);
		fileCloseBtn.addEventListener('click', closeServerFileBrowser, false);
		
		var pointerBtn = document.getElementById("sagePointerBtn");
		var pointerLabel = document.getElementById("sagePointerLabel");
		var pointerColor = document.getElementById("sagePointerColor");
		pointerBtn.addEventListener('click', startSagePointer, false);
		if(localStorage["WebSAGE_ptrName"] != null) pointerLabel.value = localStorage["WebSAGE_ptrName"];
		if(localStorage["WebSAGE_ptrColor"] != null) pointerColor.value = localStorage["WebSAGE_ptrColor"];
		
		var screenShareBtn = document.getElementById("screenShareBtn");
		screenShareBtn.addEventListener('click', startScreenShare, false);
		
		winMgr = new windowManager('winMgr', wmSocket);
		winMgr.draw();
		
		canvasKeyFunc = winMgr.keyPress.bind(winMgr);
		
		var winMgrCanvas = document.getElementById("winMgr");
		winMgrCanvas.addEventListener('mousedown', winMgr.mousePress.bind(winMgr), false);
		winMgrCanvas.addEventListener('mousemove', winMgr.mouseMove.bind(winMgr), false);
		winMgrCanvas.addEventListener('mouseup', winMgr.mouseRelease.bind(winMgr), false);
		winMgrCanvas.addEventListener('mousewheel', winMgr.mouseScroll.bind(winMgr), false);
		winMgrCanvas.addEventListener('DOMMouseScroll', winMgr.mouseScrollFF.bind(winMgr), false);
		document.addEventListener('mousemove', updateTarget, false);
				
		wmSocket.on('setupDisplayConfiguration', function(config) {
			winMgr.initDisplayConfig(config);
			var displayMin = Math.min(config.totalWidth, config.totalHeight);
			var thisMin = Math.min(screen.width, screen.height);
			sensitivity = displayMin/thisMin;
		});
		
		wmSocket.on('initialize', function(address) {
			channelId = address.replace(/\./g, '');
			roomId = address.replace(/\./g, '');
		
			connection = new RTCMultiConnection(channelId);
			connection.session = {audio: false, video: false, screen: true, data: false};
			connection.direction = "one-way";
			connection.onstream = function(stream) {
				if(stream.type === "local"){
					stream.stream.onended = function() {
						connection.close();
						screenShareBtn.disabled = false;
						wmSocket.emit('deleteElementById', roomId);
					}
				}
			};
		});
		
		wmSocket.on('addNewElement', function(elem_data) {
			winMgr.addNewElement(elem_data);
		});
		
		wmSocket.on('deleteElement', function(elemId) {
			winMgr.deleteElement(elemId);
		});
		
		wmSocket.on('updateItemOrder', function(idList) {
			winMgr.updateItemOrder(idList);
		});
		
		wmSocket.on('setItemPosition', function(position_data) {
			winMgr.setItemPosition(position_data);
		});
		
		wmSocket.on('setItemPositionAndSize', function(position_data) {
			winMgr.setItemPositionAndSize(position_data);
		});
		
		wmSocket.on('storedFileList', function(files) {
			console.log(files);
			
			var i;
			
			document.getElementById("lb_fade").style.display="block";
			document.getElementById("lb_light").style.display="block";
			
			document.getElementById("apps-dir").checked = false;
			document.getElementById("images-dir").checked = false;;
			document.getElementById("pdfs-dir").checked = false;;
			document.getElementById("videos-dir").checked = false;;
			
			var appsDir = document.getElementById("apps");
			var imagesDir = document.getElementById("images");
			var pdfsDir = document.getElementById("pdfs");
			var videosDir = document.getElementById("videos");
			
			removeAllChildren(appsDir);
			removeAllChildren(imagesDir);
			removeAllChildren(pdfsDir);
			removeAllChildren(videosDir);
			
			files["app"].sort();
			for(i=0; i<files["app"].length; i++){
				var listElem = document.createElement("li");
				listElem.innerHTML = files["app"][i];
				listElem.addEventListener('click', selectFile, false);
							
				appsDir.appendChild(listElem);
			}
			files["image"].sort();
			for(i=0; i<files["image"].length; i++){
				var listElem = document.createElement("li");
				listElem.innerHTML = files["image"][i];
				listElem.addEventListener('click', selectFile, false);
							
				imagesDir.appendChild(listElem);
			}
			files["pdf"].sort();
			for(i=0; i<files["pdf"].length; i++){
				var listElem = document.createElement("li");
				listElem.innerHTML = files["pdf"][i];
				listElem.addEventListener('click', selectFile, false);
							
				pdfsDir.appendChild(listElem);
			}
			files["video"].sort();
			for(i=0; i<files["video"].length; i++){
				var listElem = document.createElement("li");
				listElem.innerHTML = files["video"][i];
				listElem.addEventListener('click', selectFile, false);
							
				videosDir.appendChild(listElem);
			}
			
			selectedFile = null;
		});
	}
	
	function updateTarget(event) {
		var winMgrCanvas = document.getElementById("winMgr");
		
		if(event.target == winMgrCanvas && !canvasKeyEvents){
			document.addEventListener('keydown', canvasKeyFunc, false);
			canvasKeyEvents = true;
		}
		else if(event.target != winMgrCanvas && canvasKeyEvents){
			document.removeEventListener('keydown', canvasKeyFunc, false);
			canvasKeyEvents = false;
		}
	}
	
	function removeAllChildren(node) {
		while (node.lastChild) {
    		node.removeChild(node.lastChild);
		}
	}
	
	function openServerFileBrowser(event) {
		wmSocket.emit('requestStoredFiles');
	}
	
	function closeServerFileBrowser(event) {
		document.getElementById("lb_fade").style.display="none";
		document.getElementById("lb_light").style.display="none";
	}
	
	function selectServerFiles(event) {
		var directory = selectedFile.parentNode.id
		var fileName = selectedFile.innerHTML;
		
		wmSocket.emit('addNewElementFromStoredFiles', {dir: directory, name: fileName});
		console.log("load: " + fileName);
		
		closeServerFileBrowser(event);
	}
	
	function selectFile(event) {
		if(selectedFile != null) selectedFile.style.backgroundColor = "transparent";
		
		selectedFile = event.target;
		selectedFile.style.backgroundColor = "#B9D3FF";
	}
	
	function startSagePointer(event) {
		var pointerBtn = document.getElementById("sagePointerBtn");
		var pointerLabel = document.getElementById("sagePointerLabel");
		var pointerColor = document.getElementById("sagePointerColor");
		
		if(pointerLabel.value != ""){
			name = pointerLabel.value;
		}
		if(pointerColor.value != ""){
			col[0] = parseInt(pointerColor.value.substring(1,3), 16);
			col[1] = parseInt(pointerColor.value.substring(3,5), 16);
			col[2] = parseInt(pointerColor.value.substring(5,7), 16);
		}
		
		localStorage["WebSAGE_ptrName"] = pointerLabel.value;
		localStorage["WebSAGE_ptrColor"] = pointerColor.value;
		
		pointerBtn.requestPointerLock = pointerBtn.requestPointerLock ||
										pointerBtn.mozRequestPointerLock ||
										pointerBtn.webkitRequestPointerLock;

		// Ask the browser to lock the pointer)
		pointerBtn.requestPointerLock();
	}
	
	function startScreenShare(event) {
		var pointerLabel = document.getElementById("sagePointerLabel");
		var pointerColor = document.getElementById("sagePointerColor");
		
		if(pointerLabel.value != ""){
			name = pointerLabel.value;
		}
		if(pointerColor.value != ""){
			col[0] = parseInt(pointerColor.value.substring(1,3), 16);
			col[1] = parseInt(pointerColor.value.substring(3,5), 16);
			col[2] = parseInt(pointerColor.value.substring(5,7), 16);
		}
		
		localStorage["WebSAGE_ptrName"] = pointerLabel.value;
		localStorage["WebSAGE_ptrColor"] = pointerColor.value;
		
		// start screen share
		console.log(roomId);
		connection.open(roomId);
		screenShareBtn.disabled = true;
		console.log(wmSocket);
		wmSocket.emit('startNewScreenShare', {id: roomId, title: "Shared Screen: " + name, width: screen.width, height: screen.height, aspect: screen.width/screen.height});
	}
	
	function pointerLockChange() {
		pointerBtn = document.getElementById("sagePointerBtn");
	
		if(document.pointerLockElement === pointerBtn ||
		   document.mozPointerLockElement === pointerBtn ||
		   document.webkitPointerLockElement === pointerBtn){
			console.log("pointer lock enabled");
			wmSocket.emit('startSagePointer', {label: name, color: col});
			
			document.addEventListener('mousedown', pointerPress, false);
			document.addEventListener('mousemove', pointerMove, false);
			document.addEventListener('mouseup', pointerRelease, false);
			document.addEventListener('mousewheel', pointerScroll, false);
			document.addEventListener('DOMMouseScroll', pointerScrollFF, false);
			document.addEventListener('keydown', pointerKeyPress, false);
			
			pointerBtn.removeEventListener('click', startSagePointer, false);
			if(canvasKeyEvents) document.removeEventListener('keydown', canvasKeyFunc, false);
		}
		else{
			wmSocket.emit('stopSagePointer', {label: name, color: col});
			
			document.removeEventListener('mousedown', pointerPress, false);
			document.removeEventListener('mousemove', pointerMove, false);
			document.removeEventListener('mouseup', pointerRelease, false);
			document.removeEventListener('mousewheel', pointerScroll, false);
			document.removeEventListener('DOMMouseScroll', pointerScrollFF, false);
			document.removeEventListener('keydown', pointerKeyPress, false);
			
			pointerBtn.addEventListener('click', startSagePointer, false);
		}
	}
	
	function pointerPress(event) {
		wmSocket.emit('selectElementWithPointer');
		preventDefault(event);
	}
	
	function pointerRelease(event) {
		wmSocket.emit('releaseSelectedElement');
		preventDefault(event);
	}
	
	function pointerMove(event) {
		var movementX = event.movementX ||
						event.mozMovementX ||
						event.webkitMovementX ||
						0;

        var movementY = event.movementY ||
						event.mozMovementY ||
						event.webkitMovementY ||
						0;
		
		wmSocket.emit('moveSagePointer', {label: name, color: col, deltaX: Math.round(movementX*sensitivity), deltaY: Math.round(movementY*sensitivity)});	
		preventDefault(event);
	}
	
	function pointerScroll(event) {
		var scale = 1.0 + Math.abs(event.wheelDelta)/256;
		if(event.wheelDelta < 0) scale = 1.0 / scale;
		wmSocket.emit('selectScrollElementWithPointer');
		wmSocket.emit('scrollSelectedElement', scale);
		preventDefault(event);
	}
	
	function pointerScrollFF(event) {
		var wheelDelta = -120*event.detail;
		var scale = 1.0 + Math.abs(wheelDelta)/256;
		if(wheelDelta < 0) scale = 1.0 / scale;
		wmSocket.emit('selectScrollElementWithPointer');
		wmSocket.emit('scrollSelectedElement', scale);
		preventDefault(event);
	}
	
	function pointerKeyPress(event) {
		wmSocket.emit('keypressElementWithPointer', event.keyCode);
		preventDefault(event);
	}
	
	function preventDefault(event) {
		event.preventDefault();
	}
	
	function uploadFileToServer(event) {
		var i;
		event.preventDefault();
		
		var files = event.dataTransfer.files;
		var url = event.dataTransfer.getData("Url");
		var text = event.dataTransfer.getData("Text");
		if(files.length > 0){
			var formdata = new FormData();
			for(i=0; i<files.length; i++){
				formdata.append("file"+i.toString(), files[i]);
			}
			xhr = new XMLHttpRequest();
			xhr.open("POST", "/upload", true);
			xhr.upload.addEventListener('progress', function(event) {
				var fileDropText = document.getElementById("fileDropText");
				var pc = parseInt((event.loaded / event.total) * 100);
				fileDropText.innerHTML = "File upload... " + pc.toString() + "%";
				if(pc == 100){
					setTimeout(function() {
						fileDropText.innerHTML = "Drag files here to upload";
					}, 500);
				}
			}, false);
			xhr.send(formdata);
		}
		else if(url != null || text != null){
			var dataUrl;
			if(url == null) dataUrl = text;
			else if(text == null) dataUrl = url;
			else dataUrl = (url.length > text.length) ? url : text;
			var urlType = "";
			var youtube = dataUrl.indexOf("www.youtube.com");
			var ext = dataUrl.substring(dataUrl.lastIndexOf('.')+1);
			if(ext.length > 3) ext = ext.substring(0,3);
			if(youtube >= 0) urlType = "youtube";
			else if(ext == "jpg" || ext == "png") urlType = "img";
			else if(ext == "mp4") urlType = "video";
			else if(ext == "pdf") urlType = "pdf";
			console.log("URL: " + dataUrl + ", type: " + urlType);
			
			if(urlType != "") wmSocket.emit('addNewWebElement', {type: urlType, src: dataUrl});
		}
	}
	
</script>

<link rel="stylesheet" type="text/css" href="style_mgr.css" media="screen" />

</head>

<body onload="init()" onresize="winMgr.resize()">
	<div id="wrapper">
		<div id="window">
			<canvas id="winMgr" style="width: 100%;">HTML5 canvas element not supported</canvas>
		</div>
		<div id="extraIntercation">
			<div id="fileUpload">
				<div id="fileDrop">
					<p id="fileDropText">Drag files here to upload</p>
				</div>
				<label class="fileLabel">Load from Server:</label><button id="serverUploadBtn" type="button">Select Files</button>
			</div>
			<div id="sagePointer">
				<label class="sageLabel">Click to start:</label><button id="sagePointerBtn" type="button">SAGE Pointer</button><br />
				<label class="sageLabel">Pointer name:</label><input id="sagePointerLabel" type="text"></input><br />
				<label class="sageLabel">Pointer color:</label><input id="sagePointerColor" type="color"></input>
			</div>
			<div id="screenShare">
				<label class="sageLabel">Click to start:</label><button id="screenShareBtn" type="button">Share Screen</button>
			</div>
		<div>
	</div>
	
	<div class="clear"></div>
	
	<div id="lb_fade" class="lb_blackoverlay"></div>
	<div id="lb_light" class="lb_whiteboxcontainer">
		<div id="fileTreeList" class="lb_whitecontent">
			<div class="css-treeview">
				<ul>
        			<li><input type="checkbox" id="apps-dir" /><label for="apps-dir">Apps</label>
        			<ul id="apps"></ul>
        			<li><input type="checkbox" id="images-dir" /><label for="images-dir">Images</label>
        			<ul id="images"></ul>
        			<li><input type="checkbox" id="pdfs-dir" /><label for="pdfs-dir">PDFs</label>
        			<ul id="pdfs"></ul>
        			<li><input type="checkbox" id="videos-dir" /><label for="videos-dir">Videos</label>
        			<ul id="videos"></ul>
        		</ul>
			</div>
		</div>
		<div class="clear"></div>
		<div id="fileButtons">
			<button id="fileOKBtn" type="button">OK</button>
			<button id="fileCloseBtn" type="button">Close</button>
		</div>
	</div>
</body>
</html>

