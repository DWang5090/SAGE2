<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-,8">
<title>Node Test</title>
<script type="text/javascript" src="lib/socket.io.min.js"></script>
<script type="text/javascript">
	var url;
	var socket;
	
	var videos = {};
	
	function init() {
		url = window.location.origin;
		socket = io.connect(url);
		console.log("Connected to server: ", url);
		
		socket.on('addNewElement', function(elem_data) {
			var main = document.getElementById("main");
			
			if(elem_data.type == "video" || elem_data.type == "youtube"){
				var vid = document.createElement("video");
				vid.id = elem_data.id;
				vid.width = 800;
				vid.height = vid.width / elem_data.aspect;
				vid.controls = false;
				vid.ready = false
				vid.style.backgroundColor = "#333333";
				if(elem_data.resrc != null) vid.poster = elem_data.resrc;
				
				vid.addEventListener('canplay', function() {
					console.log("video can now play"); // Video is loaded and can be played
					vid.ready = true;
				}, false);
				
				vid.addEventListener('playing', function() {
					console.log("video playing");
				}, false);
				
				console.log(elem_data.src);
				
				var source = document.createElement("source");
				var param = elem_data.src.indexOf('?');
				if(param >= 0) source.src = elem_data.src + "&clientID=audio";
				else source.src = elem_data.src + "?clientID=audio";
				source.type = "video/mp4";
				vid.appendChild(source);
				
				vid.style.display = "none";
				
				videos[vid.id] = {interval: null};
				
				main.appendChild(vid);
			}
		});
		
		socket.on('deleteElement', function(elemId) {
			var deleteElem = document.getElementById(elemId);
			if(deleteElem != null) deleteElem.parentNode.removeChild(deleteElem);
		});
		
		socket.on('keypressItem', function(keypress_data) {
			var selectedElem = document.getElementById(keypress_data.elemId);
			if(selectedElem == null) return;
			
			if(keypress_data.keyCode == "32"){ // spacebar
				playPauseVideo(keypress_data.elemId);
			}
		});
	}
	
	function playPauseVideo(elemId) {
		var videoElem = document.getElementById(elemId);
		var allVideos = document.getElementsByTagName("video");
		
		for(var i=0; i<allVideos.length; i++){
			allVideos[i].style.display = "none";
		}
		
		if(videoElem.paused == true){
			videoElem.play();
			videoElem.style.display = "block";
			
			socket.emit('updateVideoTime', {elemId: videoElem.id, time: videoElem.currentTime, play: true});
			videos[videoElem.id].interval = setInterval(function() {
				socket.emit('updateVideoTime', {elemId: videoElem.id, time: videoElem.currentTime, play: true});
			}, 5000);
		}
		else{
			videoElem.pause();
			videoElem.style.display = "none";
			clearInterval(videos[videoElem.id].interval);
			socket.emit('updateVideoTime', {elemId: videoElem.id, time: videoElem.currentTime, play: false});
		}
	}
</script>

<link rel="stylesheet" type="text/css" href="style_audio.css" media="screen" />

</head>

<body onload="init()">
	<div id="main">
	</div>
</body>
</html>

