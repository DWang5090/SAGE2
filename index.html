<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-,8">
<title>Node Test</title>
<script type="text/javascript" src="lib/socket.io.min.js"></script>
<script type="text/javascript" src="scripts/pointer.js"></script>
<script type="text/javascript" src="scripts/glMatrix-0.9.5.min.js"></script>
<script type="text/javascript">
	var sysTime;
	var clientID;
	var offsetX;
	var offsetY;

	var url;
	var socket;
    
    //store total resolution so pointer events can be processed appropriately
    var totalResolutionX;
    var totalResolutionY;
	
	var canvasItems = {};
	var interactableItems = {}; //stores items that should receive events

	document.addEventListener('mousemove', mouseMove, false);
	document.addEventListener('mouseup', mouseRelease, false);
	document.addEventListener('mousewheel', mouseScroll, false);
	
	function init() {
		//document.body.style.cursor = 'text';
	
		url = window.location.origin;
		socket = io.connect(url);
		console.log("Connected to server: ", url);
		
		clientID = parseInt(getParameterByName("clientID"));
		console.log(clientID);
		
		socket.on('setSystemTime', function(time_ms) {
			sysTime = time_ms;
			console.log(sysTime);
		});

		socket.on('setupDisplayConfiguration', function(json_cfg) {
			var resolutionX = json_cfg.resolution.width;
			var resolutionY = json_cfg.resolution.height;
                  
            totalResolutionX = resolutionX * json_cfg.layout.columns;
            totalResolutionY = resolutionY * json_cfg.layout.rows;
                  
			offsetX = json_cfg.displays[clientID].column * resolutionX;
			offsetY = json_cfg.displays[clientID].row * resolutionY;
			console.log('offset: ' + offsetX + ', ' + offsetY);
		});
		
		socket.on('addScript', function(source) {
			var js = document.createElement('script')
  			js.type = "text/javascript";
  			js.src = source;
  			document.head.appendChild(js);
		});
		
		socket.on('addNewElement', function(elem_data) {
			var date = new Date(elem_data.date);
		
			var main = document.getElementById("main");
				
			var windowItem = document.createElement("div");
			windowItem.id = elem_data.id;
			windowItem.className = "windowItem";
			windowItem.style.left = (elem_data.left-offsetX).toString() + "px";
			windowItem.style.top = (elem_data.top-offsetY).toString() + "px";
			windowItem.addEventListener('mousedown', mousePress, false);
			windowItem.addEventListener('mousewheel', scrollSelect, false);
			main.appendChild(windowItem);
			
			if(elem_data.type == "img"){
				var img = document.createElement("img");
				img.id = elem_data.id + "_img";
				img.className = "sageItem";
				img.aspectRatio = elem_data.aspectRatio;
				img.width = elem_data.width;
				img.height = elem_data.height;
				img.src = elem_data.src;
				img.draggable = false;
				
				windowItem.appendChild(img);
			}
			else if(elem_data.type == "site"){
// 			    var border = 10; 
//                 var sageItm = document.createElement("div");
// //                 sageItm.id = elem_data.id + "sageItm"; 
// //                 sageItm.addEventListener('mousedown', mousePress, false);
// //                 sageItm.addEventListener('mousewheel', scrollSelect, false);
// 				sageItm.className = "sageItem";
// 				sageItm.aspectRatio = ( elem_data.width + border )/(elem_data.height + border);
// 				sageItm.width = elem_data.width+border;
// 				sageItm.height = elem_data.height+border;
// 				sageItm.src = elem_data.src;
// 				sageItm.draggable = false;
// 				
// 				windowItem.appendChild(sageItm);
			
                var ifrm = document.createElement("IFRAME"); 
//                 ifrm.className = "siteItem";
				ifrm.id = elem_data.id + "_site"
                ifrm.className = "sageItem";
                ifrm.src = elem_data.src; 
                ifrm.width =  elem_data.width;
                ifrm.height = elem_data.height;
//                 ifrm.style.border = "border: solid " + border + "px #afb7ed"; //does not work... 
                windowItem.appendChild(ifrm); 

//                 sageItm.appendChild(ifrm); 
                
//                 socket.on('pointerClick', function(x, y) {
//                     var event = document.createEvent("MouseEvents"); 
//                     event.type = "click";
//                     event.x = x;
//                     event.y = y; 
//                     
//                     ifrm.fireEvent('onclick', event ) ; 
//                 });
			}
			else if(elem_data.type == "canvas"){
				var canvas2d = document.createElement("canvas");
				canvas2d.id = elem_data.id + "_canvas"
				canvas2d.className = "sageItem";
				canvas2d.aspectRatio = elem_data.aspectRatio;
				canvas2d.width = elem_data.width;
				canvas2d.height = elem_data.height;
				
				windowItem.appendChild(canvas2d);
				
				var canvasJS = document.createElement('script')
  				canvasJS.type = "text/javascript";
  				canvasJS.src = elem_data.src;
  				document.head.appendChild(canvasJS);
  				
  				canvasJS.addEventListener('load', function(event) {
  					var canvas = new window[elem_data.extra];
  					canvas.init(elem_data.id + "_canvas", date, elem_data.resrc);
  					canvas.draw(date);
  					canvasItems[elem_data.id + "_canvas"] = canvas;
  				}, false);
			}
			else if(elem_data.type == "video"){
				var vid = document.createElement("video");
				vid.id = elem_data.id + "_video";
				vid.className = "sageItem";
				vid.aspectRatio = elem_data.aspectRatio;
				vid.width = elem_data.width;
				vid.height = elem_data.height;
				vid.controls = true;
				vid.poster = elem_data.extra;
				
				var source = document.createElement("source");
				source.src = elem_data.src;
				source.type = "video/mp4";
				vid.appendChild(source);
				
				windowItem.appendChild(vid);
			}
		});

		
		socket.on('itemSelected', function(elemId) {
			var selectedElem = document.getElementById(elemId);
			
			moveItemToFront(selectedElem);
		});
		
		socket.on('setItemPosition', function(position_data) {
			var date = new Date(position_data.date);
			var selectedElem = document.getElementById(position_data.elemId);
			
			var eLeft = position_data.elemLeft - offsetX;
			var eTop = position_data.elemTop - offsetY;
			
			selectedElem.style.left = eLeft.toString() + "px";
			selectedElem.style.top = eTop.toString() + "px";
		});
		
		socket.on('setItemPositionAndSize', function(position_data) {
			var date = new Date(position_data.date);
			var selectedElem = document.getElementById(position_data.elemId);
			
			var eLeft = position_data.elemLeft - offsetX;
			var eTop = position_data.elemTop - offsetY;
			
			selectedElem.style.left = eLeft.toString() + "px";
			selectedElem.style.top = eTop.toString() + "px";
			
			var child = selectedElem.getElementsByClassName("sageItem");
			child[0].width = Math.round(position_data.elemWidth);
			child[0].height = Math.round(position_data.elemHeight);
			
			if(child[0].tagName.toLowerCase() == "canvas"){
				canvasItems[child[0].id].draw(date)
			}
			if( child[0].tagName.toLowerCase() == "iframe"){ //resize an iframe
			    console.log("side resized");
                var e = document.createEvent('HTMLEvents'); 
                e.initEvent('resize', true, false);
                child[0].dispatchEvent(e);
			}
		});
		
		socket.on('animateCanvas', function(animate_data) {
			var date = new Date(animate_data.date);
			
			var canvasElem = document.getElementById(animate_data.elemId);
			var child = canvasElem.getElementsByClassName("sageItem");
			if(child[0].tagName.toLowerCase() == "canvas"){
				canvasItems[child[0].id].draw(date);
			}
		});
		
		
		//----------------------------------------------------------------//
        //---------------------------  POINTER  --------------------------//
        //----------------------------------------------------------------//

        //----------CREATE POINTER-----------
        socket.on('createPointer', function(pointerData){
            var main = document.getElementById("main");

            var pointerImage = document.getElementById( pointerData.id );
            pointerImage = document.createElement("canvas"); //create canvas element
            pointerImage.id = pointerData.id; 
            pointerImage.className = "pointerItem";
            pointerImage.aspectRatio = 36/48;//pointerData.aspectRatio;
            pointerImage.width = 48*3;//pointerData.width;
            pointerImage.height = 48;//pointerData.height;
            pointerImage.style.left = (-100-offsetX).toString() + "px";
            pointerImage.style.top = (-100-offsetY).toString() + "px";

            main.appendChild(pointerImage); 

            var ptr = new pointer() ; 
            ptr.init(pointerImage.id, pointerData.label, pointerData.color) ;
            ptr.draw(); 
    
            //----------MOVE POINTER-----------
            socket.on('movePointer', function(position_data){
                var selectedElem = document.getElementById(position_data.elemId);
                elemLeftPix = position_data.elemLeft * totalResolutionX;
                elemTopPix =  position_data.elemTop * totalResolutionY;

                var eLeft = elemLeftPix - offsetX;
                var eTop = elemTopPix - offsetY;

                console.log( "pointer move: " + eLeft + " " + eTop );

                selectedElem.style.left = eLeft.toString() + "px";
                selectedElem.style.top = eTop.toString() + "px";
              });
            
            socket.on('pointerScroll', function(scroll_data){
                console.log("zoom   " );
                
                event = document.createEvent("MouseEvent");   
                event.x = scroll_data.x * totalResolutionX - offsetX;
                event.y = scroll_data.y * totalResolutionY - offsetY;   
                //need target
                pointerScrollSelect( event, scroll_data.elemZoom );
              });
          
              socket.on('changeMode', function(mode){
                ptr.setColor( [0, 0, 0, 1] );
                ptr.draw();
              });
          });
        

       //  //Single pointer only
//         socket.on('movePointer', function(position_data){
//             var selectedElem = document.getElementById(position_data.elemId);
//             elemLeftPix = position_data.elemLeft * totalResolutionX;
//             elemTopPix =  position_data.elemTop * totalResolutionY;
// 
//             var eLeft = elemLeftPix - offsetX;
//             var eTop = elemTopPix - offsetY;
// 
//             console.log( "pointer move: " + eLeft + " " + eTop );
// 
//             selectedElem.style.left = eLeft.toString() + "px";
//             selectedElem.style.top = eTop.toString() + "px";
//             
//             var script = selectedElem.getElement("script"); 
// //             pointer().color = "rgba(255, 0, 0, 1)";
//             
// //             selectedElem.
//           });
        //-------------------------  END POINTER -------------------------//
	}

	function mousePress(event) {
		var globalX = event.clientX + offsetX;
		var globalY = event.clientY + offsetY;
		
		var leftpx = event.currentTarget.style.left;
		var toppx = event.currentTarget.style.top;
		
		var eLeft = parseInt(leftpx.substring(0,leftpx.length-2)) + offsetX;
		var eTop = parseInt(toppx.substring(0,toppx.length-2))+ offsetY;
		
		var selectOffsetX = eLeft - globalX;
		var selectOffsetY = eTop - globalY;
		
		socket.emit('selectElementById', {elemId: event.currentTarget.id, eventOffsetX: selectOffsetX, eventOffsetY: selectOffsetY});
	}
	
	function mouseMove(event) {
		var globalX = event.clientX + offsetX;
		var globalY = event.clientY + offsetY;
		socket.emit('moveSelectedElement', {eventX: globalX, eventY: globalY});
	}
	
	function mouseRelease(event) {
		socket.emit('releaseSelectedElement');
	}
	
	function scrollSelect(event) {
		socket.emit('selectScrollElementById', event.currentTarget.id);
	}
	
	function mouseScroll(event) {
		var scale = 1.0 + Math.abs(event.wheelDelta)/256;
		if(event.wheelDelta < 0) scale = 1.0 / scale;
		
		socket.emit('scrollSelectedElement', scale);
	}
	
	function pointerScrollSelect(event, zoom){
	    console.log("in pointer scroll select");
        socket.emit('selectScrollElementById', event.currentTarget.id);
        if(zoom < 0) zoom = 1.0 / zoom;

        socket.emit('scrollSelectedElement', zoom);
	}
	
	function moveItemToFront(elem) {
		var last = elem.parentNode.lastChild;
		if(elem != last){
			elem.parentNode.replaceChild(elem, last);
			elem.parentNode.insertBefore(last, elem);
		}
	}

	function getParameterByName(name) {
		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
		return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
</script>

<link rel="stylesheet" type="text/css" href="style.css" media="screen" />

</head>

<body onload="init()" onclick="console.log(window.event)">
	<div id="main">
	</div>
</body>
</html>

