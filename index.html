<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-,8">
<title>Node Test</title>
<script type="text/javascript" src="lib/socket.io.min.js"></script>
<script type="text/javascript" src="scripts/pointer.js"></script>
<script type="text/javascript" src="scripts/videoControls.js"></script>
<script type="text/javascript" src="scripts/glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="scripts/kinetic-v4.7.4.min.js"></script>
<script type="text/javascript" src="scripts/three.min.js"></script>
<script type="text/javascript">
	var sysTime;
	var clientID;
	var offsetX;
	var offsetY;
	var titleBarHeight;
	var titleTextSize;

	var url;
	var socket;
    
    //store total resolution so pointer events can be processed appropriately
    var totalResolutionX;
    var totalResolutionY;
	
	var itemCount = 0;
	var canvasItems = {};
	var interactableItems = {}; //stores items that should receive events

	//document.addEventListener('mousemove', mouseMove, false);
	//document.addEventListener('mouseup', mouseRelease, false);
	//document.addEventListener('mousewheel', mouseScroll, false);
	
	function init() {
		document.body.style.cursor = 'none'; // page needs to have mouse in focus to initiate 
	
		url = window.location.origin;
		socket = io.connect(url);
		console.log("Connected to server: ", url);
		
		clientID = parseInt(getParameterByName("clientID"));
		console.log(clientID);
		
		socket.on('setSystemTime', function(time_ms) {
			sysTime = time_ms;
			console.log(sysTime);
		});

		socket.on('setupDisplayConfiguration', function(json_cfg) {
                  
            totalResolutionX = json_cfg.resolution.width * json_cfg.layout.columns;
            totalResolutionY = json_cfg.resolution.height * json_cfg.layout.rows;
                  
			offsetX = json_cfg.displays[clientID].column * json_cfg.resolution.width;
			offsetY = json_cfg.displays[clientID].row * json_cfg.resolution.height;
			
			titleBarHeight = json_cfg.titleBarHeight;
			titleTextSize = json_cfg.titleTextSize;
			
			console.log('offset: ' + offsetX + ', ' + offsetY);
		});
		
		socket.on('addScript', function(source) {
			var js = document.createElement('script')
  			js.type = "text/javascript";
  			js.src = source;
  			document.head.appendChild(js);
		});
		
		socket.on('addNewElement', function(elem_data) { //server receives an element, then calls this function to add it on the wall
			var date = new Date(elem_data.date);
		
			var main = document.getElementById("main");
			
			var windowTitle = document.createElement("div");
			windowTitle.id = elem_data.id + "_title";
			windowTitle.className = "windowTitle";
			windowTitle.style.width = elem_data.width.toString() + "px";
			windowTitle.style.height = titleBarHeight.toString() + "px";
			windowTitle.style.left = (elem_data.left-offsetX).toString() + "px";
			windowTitle.style.top = (elem_data.top-offsetY).toString() + "px";
			windowTitle.style.zIndex = itemCount.toString();
			main.appendChild(windowTitle);
			
			var titleText = document.createElement("p");
			titleText.style.lineHeight = Math.round(titleBarHeight) + "px";
			titleText.style.fontSize = Math.round(titleTextSize) + "px";
			titleText.style.color = "#FFFFFF";
			titleText.style.marginLeft = Math.round(titleBarHeight/4) + "px";
			titleText.textContent = elem_data.title;
			windowTitle.appendChild(titleText);
			
			var windowItem = document.createElement("div");
			windowItem.id = elem_data.id;
			windowItem.className = "windowItem";
			windowItem.style.left = (elem_data.left-offsetX).toString() + "px";
			windowItem.style.top = (elem_data.top+titleBarHeight-offsetY).toString() + "px";
			windowItem.style.zIndex = (itemCount+1).toString();
			//windowItem.addEventListener('mousedown', mousePress, false);
			//windowItem.addEventListener('mousewheel', scrollSelect, false);
			main.appendChild(windowItem);
			
			if(elem_data.type == "img"){
				var img = document.createElement("img");
				img.id = elem_data.id + "_img";
				img.className = "sageItem";
				img.aspectRatio = elem_data.aspectRatio;
				img.width = elem_data.width;
				img.height = elem_data.height;
				img.src = elem_data.src;
				img.draggable = false;
				
				windowItem.appendChild(img);
			}
			else if(elem_data.type == "site"){

                			
                var ifrm = document.createElement("IFRAME"); 
				ifrm.id = elem_data.id + "_site"
                ifrm.className = "sageItem";
                ifrm.src = elem_data.src; 
                ifrm.width =  elem_data.width;
                ifrm.height = elem_data.height;
                windowItem.appendChild(ifrm); 
//                 console.log("source:" + elem_data.src);

			}
			else if(elem_data.type == "canvas" || elem_data.type == "webgl"){
				var canvas = document.createElement("canvas");
				canvas.id = elem_data.id + "_canvas"
				canvas.className = "sageItem";
				canvas.aspectRatio = elem_data.aspectRatio;
				canvas.width = elem_data.width;
				canvas.height = elem_data.height;
			
				windowItem.appendChild(canvas);
			
				var canvasJS = document.createElement('script')
				canvasJS.type = "text/javascript";
				canvasJS.src = elem_data.src;
				document.head.appendChild(canvasJS);
			
				canvasJS.addEventListener('load', function(event) {
					var canvasObj = new window[elem_data.extra];
					canvasObj.init(elem_data.id + "_canvas", date, elem_data.resrc);
					canvasObj.draw(date);
					canvasItems[elem_data.id + "_canvas"] = canvasObj;
				}, false);
			}
			else if(elem_data.type == "kineticjs"){
				var kineticjs = document.createElement("div");
				kineticjs.id = elem_data.id + "_kineticjs"
				kineticjs.className = "sageItem";
				kineticjs.aspectRatio = elem_data.aspectRatio;
				kineticjs.width = elem_data.width;
				kineticjs.height = elem_data.height;
			
				windowItem.appendChild(kineticjs);
// >>>>>>> 13b4f1e630f3b9b59b8c69c4794ef5014aef9aec
// 				
// 				var kineticjsJS = document.createElement('script')
// 				kineticjsJS.type = "text/javascript";
// 				kineticjsJS.src = elem_data.src;
// 				document.head.appendChild(kineticjsJS);
// 				
// 				kineticjsJS.addEventListener('load', function(event) {
// 					var kineticjsObj = new window[elem_data.extra];
// 					kineticjsObj.init(elem_data.id + "_kineticjs", date, elem_data.resrc);
// 					canvasItems[elem_data.id + "_kineticjs"] = kineticjsObj;
// 				}, false);
			}
			else if(elem_data.type == "threejs"){
				var threejs = document.createElement("div");
				threejs.id = elem_data.id + "_threejs"
				threejs.className = "sageItem";
				threejs.aspectRatio = elem_data.aspectRatio;
				threejs.width = elem_data.width;
				threejs.height = elem_data.height;
			
				windowItem.appendChild(threejs);
				
				var threejsJS = document.createElement('script')
				threejsJS.type = "text/javascript";
				threejsJS.src = elem_data.src;
				document.head.appendChild(threejsJS);
				
				threejsJS.addEventListener('load', function(event) {
					var threejsObj = new window[elem_data.extra];
					threejsObj.init(elem_data.id + "_threejs", date, elem_data.resrc);
					canvasItems[elem_data.id + "_threejs"] = threejsObj;
				}, false);
			}
			else if(elem_data.type == "video" || elem_data.type == "youtube"){
				var vid = document.createElement("video");
				vid.id = elem_data.id + "_video";
				vid.className = "sageItem";
				vid.aspectRatio = elem_data.aspectRatio;
				vid.width = elem_data.width;
				vid.height = elem_data.height;
				vid.controls = false;
				vid.style.backgroundColor = "#333333";
				if(elem_data.extra != null) vid.poster = elem_data.extra;
				
				vid.addEventListener('canplay', function() {
					console.log("video can now play"); // Video is loaded and can be played
				}, false);
				
				console.log(elem_data.src);
				
				if(elem_data.src != null){
					var source1 = document.createElement("source");
					var param = elem_data.src.indexOf('?');
					if(param >= 0) source1.src = elem_data.src + "&clientID=" + clientID.toString();
					else source1.src = elem_data.src + "?clientID=" + clientID.toString();
					source1.type = "video/mp4";
					vid.appendChild(source1);
				}
				
				if(elem_data.resrc != null){
					var source2 = document.createElement("source");
					var param = elem_data.resrc.indexOf('?');
					if(param >= 0) source2.src = elem_data.resrc + "&clientID=" + clientID.toString();
					else source2.src = elem_data.resrc + "?clientID=" + clientID.toString();
					source2.type = "video/webm";
					vid.appendChild(source2);
				}
				
				windowItem.appendChild(vid);
			}
			else if(elem_data.type == "metadata"){	
                var ifrm = document.createElement("IFRAME"); 
				ifrm.id = elem_data.id + "_site";
                ifrm.className = "sageItem";
                ifrm.src = "http://localhost:9090/apps/metadataDisplay/metadataDisplay.html"; 
                ifrm.width =  elem_data.width;
                ifrm.height = elem_data.height;
                //ifrm.filename = elem_data.src;
                windowItem.appendChild(ifrm); 
                
//                 ifrm.contentWindow.postMessage('metadataLoad ' + elem_data.src, '*');  
			}
			
			itemCount += 2;
		});

		
		socket.on('deleteElement', function(elemId) {
			var deleteElemTitle = document.getElementById(elemId + "_title");
			deleteElemTitle.parentNode.removeChild(deleteElemTitle);
			
			var deleteElem = document.getElementById(elemId);
			deleteElem.parentNode.removeChild(deleteElem);
		});
		
		socket.on('updateItemOrder', function(idList) {
			var i;
			var zval = 0;
			for(i=0; i<idList.length; i++){
				var selectedElemTitle = document.getElementById(idList[i] + "_title");
				var selectedElem = document.getElementById(idList[i]);
				
				selectedElemTitle.style.zIndex = zval.toString();
				selectedElem.style.zIndex = (zval+1).toString();
				
				zval += 2;
			}
		});
		
		socket.on('setItemPosition', function(position_data) {
			var date = new Date(position_data.date);
			
			var eLeft = position_data.elemLeft - offsetX;
			var eTop = position_data.elemTop - offsetY;
			
			var selectedElemTitle = document.getElementById(position_data.elemId + "_title");
			selectedElemTitle.style.left = eLeft.toString() + "px";
			selectedElemTitle.style.top = eTop.toString() + "px";
			
			var selectedElem = document.getElementById(position_data.elemId);
			selectedElem.style.left = eLeft.toString() + "px";
			selectedElem.style.top = (eTop+titleBarHeight).toString() + "px";
		});
		
		socket.on('setItemPositionAndSize', function(position_data) {
			var date = new Date(position_data.date);
			
			var eLeft = position_data.elemLeft - offsetX;
			var eTop = position_data.elemTop - offsetY;
			
			var selectedElemTitle = document.getElementById(position_data.elemId + "_title");
			selectedElemTitle.style.left = eLeft.toString() + "px";
			selectedElemTitle.style.top = eTop.toString() + "px";
			selectedElemTitle.style.width = Math.round(position_data.elemWidth).toString() + "px";
			
			var selectedElem = document.getElementById(position_data.elemId);
			selectedElem.style.left = eLeft.toString() + "px";
			selectedElem.style.top = (eTop+titleBarHeight).toString() + "px";
			
			var child = selectedElem.getElementsByClassName("sageItem");
			child[0].width = Math.round(position_data.elemWidth);
			child[0].height = Math.round(position_data.elemHeight);
			
			if(child[0].id.substring(child[0].id.length - 6) == "canvas"){
				canvasItems[child[0].id].draw(date);
			}
			if( child[0].tagName.toLowerCase() == "iframe"){ //resize an iframe
			    console.log("side resized");
                var e = document.createEvent('HTMLEvents'); 
                e.initEvent('resize', true, false);
                child[0].dispatchEvent(e);
			}
			if(child[0].id.substring(child[0].id.length - 7) == "kineticjs"){
				canvasItems[child[0].id].resize(date);
			}
			if(child[0].id.substring(child[0].id.length - 7) == "threejs"){
				canvasItems[child[0].id].resize(date);
			}
		});
		
		socket.on('playPauseVideo', function(elemId) {
			var videoElem = document.getElementById(elemId + "_video");
			console.log(videoElem);
			if(videoElem.paused == true){ videoElem.play(); console.log("play"); }
			else{ videoElem.pause(); console.log("pause"); }
		});
		
		socket.on('animateCanvas', function(animate_data) {
			var date = new Date(animate_data.date);
			
			var canvasElem = document.getElementById(animate_data.elemId);
			var child = canvasElem.getElementsByClassName("sageItem");
			if(animate_data.type == "canvas" || animate_data.type == "webgl" || animate_data.type == "kineticjs" || animate_data.type == "threejs"){
				canvasItems[child[0].id].draw(date);
			}
		});
		
		
		//----------------------------------------------------------------//
        //---------------------------  POINTER  --------------------------//
        //----------------------------------------------------------------//

        //----------CREATE POINTER-----------
        socket.on('createPointer', function(pointerData){
            var main = document.getElementById("main");

//             var pointerImage = document.getElementById( pointerData.id );
            var pointerImage = document.createElement("canvas"); //create canvas element
            pointerImage.id = pointerData.id; 
            pointerImage.className = "pointerItem";
            pointerImage.aspectRatio = 36/48;//pointerData.aspectRatio;
            pointerImage.width = 48*3;//pointerData.width;
            pointerImage.height = 48;//pointerData.height;
            pointerImage.style.left = (-100-offsetX).toString() + "px";
            pointerImage.style.top = (-100-offsetY).toString() + "px";
            pointerImage.style.zIndex = "10000"; 

            main.appendChild(pointerImage); 

            var ptr = new pointer() ; 
            ptr.init(pointerImage.id, pointerData.label, pointerData.color) ;
            ptr.draw(); 
    
            //----------MOVE POINTER-----------
            socket.on('movePointer', function(position_data){
                var selectedElem = document.getElementById(position_data.elemId);
                elemLeftPix = position_data.elemLeft * totalResolutionX;
                elemTopPix =  position_data.elemTop * totalResolutionY;

                var eLeft = elemLeftPix - offsetX;
                var eTop = elemTopPix - offsetY;

                console.log( "pointer move: " + eLeft + " " + eTop );

                selectedElem.style.left = eLeft.toString() + "px";
                selectedElem.style.top = eTop.toString() + "px";
                
              });
          
              socket.on('changeMode', function(mode){
                console.log("changeMode");
                if( mode == 1 ){
                    ptr.changeMode(1);
                }
                else if( mode == 0 ){
                    ptr.changeMode(0);
                }
                ptr.draw();
              });
          });
          
          socket.on('processClick', function(ptr_data){
            var x = ptr_data.x ;//- offsetX;
            var y = ptr_data.y ;// -offsetY;
            var ptrId = ptr_data.ptrId; 
            var elemId = ptr_data.elemId; 
            
            
            console.log( "x = " + x + " y = " + y + " ptrId = " + ptrId + " elemId = " + elemId ); 
            
            var selectedWindow = document.getElementById(ptr_data.elemId);
			var child = selectedWindow.getElementsByClassName("sageItem");
			//if(child[0].tagName.toLowerCase() == "site"){
            console.log(child[0]);
            child[0].contentWindow.postMessage('pointerClick x ' + x + " y " + y, '*');  

//                 var oEvent = document.createEvent('MouseEvents');
//                 oEvent.initMouseEvent(
//                     'click'          // event type
//                     ,true           // can bubble?
//                     ,true          // cancelable?
//                     ,window      // the event's abstract view (should always be window)
//                     ,0              // mouse click count (or event "detail")
//                     ,x        // event's screen x coordinate
//                     ,y          // event's screen y coordinate
//                     ,x           // event's client x coordinate
//                     ,y           // event's client y coordinate
//                     ,false         // whether or not CTRL was pressed during event
//                     ,false         // whether or not ALT was pressed during event
//                     ,false         // whether or not SHIFT was pressed during event
//                     ,false         // whether or not the meta key was pressed during event
//                     ,1             // indicates which button (if any) caused the mouse event (1 = primary button)
//                     ,null          // relatedTarget (only applicable for mouseover/mouseout events)
//                 );
// 
// 
//                 child[0].dispatchEvent( oEvent );

			//}
            
            
//             var selectedElement = document.getElementById( ptr_data.elemId+"_site" );
//             console.log(selectedElement);
// 
//             selectedElement.contentWindow.postMessage('pointerClick x ' + x + " y " + y, '*');  
//             selectedElement.dispatchEvent(e);
          
          });  
            
//             var selectedElement = document.getElementById( ptr_data.elemId+"_site" );
//              console.log(selectedElement);
// //             var inside = iframeRef( document.getElementById(elemId+"_site") );
// //             console.log(inside);
//             var e = document.createEvent('MouseEvents'); 
//             e.initMouseEvent('click', false, false, false,
//             0, 800, 0, 800, 0, //x-offsetX, y-offsetY, x-offsetX, y-offsetY,
//             false, false,false, false, 0, selectedElement ); 
            
//             MouseEvent {dataTransfer: null, toElement: p, fromElement: null, y: 19, x: 481…}
// altKey: false
// bubbles: true
// button: 0
// cancelBubble: false
// cancelable: true
// charCode: 0
// clientX: 481
// clientY: 19
// clipboardData: undefined
// ctrlKey: false
// currentTarget: null
// dataTransfer: null
// defaultPrevented: false
// detail: 1
// eventPhase: 0
// fromElement: null
// keyCode: 0
// layerX: 481
// layerY: 19
// metaKey: false
// offsetX: 475
// offsetY: 18
// pageX: 481
// pageY: 19
// relatedTarget: null
// returnValue: true
// screenX: 549
// screenY: 196
// shiftKey: false
// srcElement: p
// target: p
// timeStamp: 1384845340520
// toElement: p
// type: "click"
// view: Window
// webkitMovementX: 0
// webkitMovementY: 0
// which: 1
// x: 481
// y: 19

        

       //  //Single pointer only
//         socket.on('movePointer', function(position_data){
//             var selectedElem = document.getElementById(position_data.elemId);
//             elemLeftPix = position_data.elemLeft * totalResolutionX;
//             elemTopPix =  position_data.elemTop * totalResolutionY;
// 
//             var eLeft = elemLeftPix - offsetX;
//             var eTop = elemTopPix - offsetY;
// 
//             console.log( "pointer move: " + eLeft + " " + eTop );
// 
//             selectedElem.style.left = eLeft.toString() + "px";
//             selectedElem.style.top = eTop.toString() + "px";
//             
//             var script = selectedElem.getElement("script"); 
// //             pointer().color = "rgba(255, 0, 0, 1)";
//             
// //             selectedElem.
//           });
        //-------------------------  END POINTER -------------------------//
	}
	
	function iframeRef( frameRef ) {
        return frameRef.contentWindow ? frameRef.contentWindow.document : frameRef.contentDocument  //I don't think I am using this... 
    }


    function mousePress(event) {
		console.log(event);
	}

	/*
	function mousePress(event) {
		var globalX = event.clientX + offsetX;
		var globalY = event.clientY + offsetY;
		
		var leftpx = event.currentTarget.style.left;
		var toppx = event.currentTarget.style.top;
		
		var eLeft = parseInt(leftpx.substring(0,leftpx.length-2)) + offsetX;
		var eTop = parseInt(toppx.substring(0,toppx.length-2))+ offsetY;
		
		var selectOffsetX = eLeft - globalX;
		var selectOffsetY = eTop - globalY;
		
		socket.emit('selectElementById', {elemId: event.currentTarget.id, eventOffsetX: selectOffsetX, eventOffsetY: selectOffsetY});
	}
	
	function mouseMove(event) {
		var globalX = event.clientX + offsetX;
		var globalY = event.clientY + offsetY;
		socket.emit('moveSelectedElement', {eventX: globalX, eventY: globalY});
	}
	
	function mouseRelease(event) {
		socket.emit('releaseSelectedElement');
	}
	
	function scrollSelect(event) {
		socket.emit('selectScrollElementById', event.currentTarget.id);
	}
	
	function mouseScroll(event) {
		var scale = 1.0 + Math.abs(event.wheelDelta)/256;
		if(event.wheelDelta < 0) scale = 1.0 / scale;
		socket.emit('scrollSelectedElement', scale);
	}
	*/
	
// 	function pointerScrollSelect(event, zoom){
// 	    console.log("in pointer scroll select");
//         socket.emit('selectScrollElementById', event.currentTarget.id);
// //         if(zoom < 0) zoom = 1.0 / zoom;
// // 
// //         socket.emit('scrollSelectedElement', zoom);
// 	}
	
	function moveItemToFront(elem) {
		var last = elem.parentNode.lastChild;
		if(elem != last){
			elem.parentNode.replaceChild(elem, last);
			elem.parentNode.insertBefore(last, elem);
		}
	}

	function getParameterByName(name) {
		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
		return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
	
// 	window.onmessage = function(e){
// 	    console.log("message received: " + e);
//         
//     };


///------------LISTEN FOR EVENTS FROM CHILD IFRAMES-----------------
window.addEventListener("message", receiveMessage, false);
function receiveMessage(event)
{
//   if (event.origin !== "http://example.org:8080")  //may add this later for security concerns
//     return;
//     if (event.data.indexOf( 'pointerClick') != -1) {
//         var tokens = event.data.split(' ');
//         pointerX = tokens[2];
//         pointerY = tokens[4]; 
//         pointerPressed = true;     
//         readyRedraw = true;     
//     }
//     if (event.data.indexOf( 'pointerMove') != -1) {
//         var tokens = event.data.split(' ');
//         pointerX = tokens[2];
//         pointerY = tokens[4]; 
//         readyRedraw = true;     
//     } 
 	    console.log("message received: " + event.data);
 	    
 	    //ONCE RECEIVED:  communicate these events back to the server
 	    //socket.emit('pointerEventRecorded'); 
 	    

}


</script>

<link rel="stylesheet" type="text/css" href="style.css" media="screen" />

</head>

<body onload="init()" onclick="console.log(window.event)">
	<div id="main">
	</div>
</body>
</html>

