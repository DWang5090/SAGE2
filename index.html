<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="utf-,8">
<title>Node Test</title>
<script type="text/javascript" src="lib/socket.io.min.js"></script>
<script type="text/javascript" src="lib/firebase.js"></script>
<script type="text/javascript" src="lib/RTCPeerConnection-v1.5.js"></script>
<script type="text/javascript" src="lib/broadcast.js"></script>
<script type="text/javascript" src="scripts/pointer.js"></script>
<script type="text/javascript" src="scripts/pdf.js"></script>
<script type="text/javascript" src="scripts/pdf_canvas.js"></script>
<script type="text/javascript" src="scripts/glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="scripts/kinetic-v4.7.4.min.js"></script>
<script type="text/javascript" src="scripts/three.min.js"></script>
<script type="text/javascript">
	var clientID;
	var offsetX;
	var offsetY;
	var titleBarHeight;
	var titleTextSize;
	var pointerWidth;
	var pointerHeight;
	var pointerOffsetX; 
	var pointerOffsetY;

	var url;
	var socket_io;
	
	var itemCount = 0;
	var pdfItems = {};
	var pointerItems = {};
	var canvasItems = {};
	var broadcastUI = {};
	var rooms = {};
	
	function init() {
		url = window.location.origin;
		socket_io = io.connect(url);
		console.log("Connected to server: ", url);
		
		clientID = parseInt(getParameterByName("clientID"));
		console.log(clientID);

		socket_io.on('setupDisplayConfiguration', function(json_cfg) {
			offsetX = json_cfg.displays[clientID].column * json_cfg.resolution.width;
			offsetY = json_cfg.displays[clientID].row * json_cfg.resolution.height;
			titleBarHeight = json_cfg.titleBarHeight;
			titleTextSize = json_cfg.titleTextSize;
			pointerWidth = json_cfg.pointerWidth;
			pointerHeight = json_cfg.pointerHeight;
			pointerOffsetX = Math.round(0.025384*pointerHeight); 
			pointerOffsetY = Math.round(0.060805*pointerHeight);
			console.log('offset: ' + offsetX + ', ' + offsetY);
		});
		
		socket_io.on('newBroadcastClient', function(address) {
			var origin = url.replace( /\/|:|#|%|\.|\[|\]/g , '');
			var channel = address.replace( /\/|:|#|%|\.|\[|\]/g , '');
		
			var config = {
				openSocket: function(config) {
					var origin = config.channel || url.replace( /\/|:|#|%|\.|\[|\]/g , '');
					var socket = new Firebase('https://chat.firebaseIO.com/' + origin + channel);
					socket.channel = channel;
					socket.on("child_added", function(data) {
						config.onmessage && config.onmessage(data.val());
					});
					socket.send = function(data) {
						this.push(data);
					};
					config.onopen && setTimeout(config.onopen, 1);
					socket.onDisconnect().remove();
					return socket;
				},
				onRemoteStream: function(htmlElement) {
					if(document.getElementById(channel)) return;
					
					var main = document.getElementById("main");
                        
					var id = channel;
		
					var windowItem = document.createElement("div");
					windowItem.id = id;
					windowItem.className = "windowItem";
					windowItem.style.left = (0-offsetX).toString() + "px";
					windowItem.style.top = (0+titleBarHeight-offsetY).toString() + "px";
					windowItem.style.zIndex = (itemCount+1).toString();
					main.appendChild(windowItem);
				
					htmlElement.id = id + "_screen";
					htmlElement.className = "sageItem";
					htmlElement.controls = false;
					htmlElement.play();
					windowItem.appendChild(htmlElement);
					
					socket_io.emit('streamAdded', {id: id, client: clientID});
				},
				onRoomFound: function(room) {
					if(rooms[channel].indexOf(room.broadcaster) >= 0) return;
		
					console.log("found room: " + room.broadcaster + "(" + channel + ")");
		
					var broadcaster = room.broadcaster;
					var roomToken = room.broadcaster;
					broadcastUI[channel].joinRoom({
						roomToken: roomToken,
						joinUser: broadcaster
					});
		
					rooms[channel].push(room.broadcaster);
				},
				onNewParticipant: function(numberOfViewers) {
					// do nothing
				}
			};

			broadcastUI[channel] = broadcast(config);
			rooms[channel] = [];
		});
		
		socket_io.on('addScript', function(source) {
			var js = document.createElement('script')
  			js.type = "text/javascript";
  			js.src = source;
  			document.head.appendChild(js);
		});
		
		socket_io.on('createPointer', function(pointer_data){
            var main = document.getElementById("main");
            
            console.log("creating pointer: " + pointerWidth + "x" + pointerHeight);
            console.log(pointer_data.id, pointer_data.label, pointer_data.color)
            
            var pointerElem = document.createElement("canvas");
            pointerElem.id = pointer_data.id; 
            pointerElem.className = "pointerItem";
            pointerElem.width = pointerWidth;
            pointerElem.height = pointerHeight;
            pointerElem.style.left = (pointer_data.left-pointerOffsetX-offsetX).toString() + "px";
            pointerElem.style.top = (pointer_data.top-pointerOffsetY-offsetY).toString() + "px";
            pointerElem.style.zIndex = "10000"; 
            pointerElem.mode = pointer_data.mode; //mode indicates how pointer interacts w
    
            main.appendChild(pointerElem); 

            var ptr = new pointer(); 
            ptr.init(pointerElem.id, pointer_data.label, pointer_data.color) ;
            ptr.changeMode( pointerElem.mode ) 
            ptr.draw();
            
            pointerItems[pointerElem.id] = ptr;
        });
        
        socket_io.on('showPointer', function(pointer_data){
        	var pointerElem = document.getElementById(pointer_data.id);
        	
        	pointerElem.style.display = "block";
        	pointerElem.style.left = (pointer_data.left-pointerOffsetX-offsetX).toString() + "px";
            pointerElem.style.top = (pointer_data.top-pointerOffsetY-offsetY).toString() + "px";
            
            pointerItems[pointerElem.id].setLabel(pointer_data.label);
            pointerItems[pointerElem.id].setColor(pointer_data.color);
            pointerItems[pointerElem.id].draw();
        });
        
        socket_io.on('hidePointer', function(pointer_data){
        	var pointerElem = document.getElementById(pointer_data.id);
        	
        	pointerElem.style.display = "none";
        });
        
        socket_io.on('updatePointer', function(pointer_data){
        	var pointerElem = document.getElementById(pointer_data.id);
        	
        	pointerElem.style.left = (pointer_data.left-pointerOffsetX-offsetX).toString() + "px";;
        	pointerElem.style.top = (pointer_data.top-pointerOffsetY-offsetY).toString() + "px";
        });
        
        socket_io.on('pointerClickInItem', function( click_data ) { 
            var ptr_id = click_data.ptr_id;
            var globalX = click_data.globalX;
            var globalY = click_data.globalY;
            var itemRelativeX = click_data.itemRelativeX;
            var itemRelativeY = click_data.itemRelativeY - titleBarHeight;   
                        
            var selectedElem = document.getElementById(click_data.elemId);
            var child = selectedElem.getElementsByClassName("sageItem");
            
            console.log(click_data.elemId, " " , itemRelativeX, " ", itemRelativeY, " ", child[0].tagName.toLowerCase() );
            if(child[0].tagName.toLowerCase() == "iframe"){
                console.log(child[0]);
                child[0].contentWindow.postMessage('pointerClick x ' + itemRelativeX + " y " + itemRelativeY, '*');  
            }

        });
        
        socket_io.on('pointerChangeMode', function(pointer_data){
            var pointerElem = document.getElementById(pointer_data.id);
        
            pointerItems[pointerElem.id].changeMode(pointer_data.mode);
            pointerItems[pointerElem.id].draw();
        });
		
		socket_io.on('addNewElement', function(elem_data) {		
			var date = new Date(elem_data.date);
		
			var main = document.getElementById("main");
			
			var windowTitle = document.createElement("div");
			windowTitle.id = elem_data.id + "_title";
			windowTitle.className = "windowTitle";
			windowTitle.style.width = elem_data.width.toString() + "px";
			windowTitle.style.height = titleBarHeight.toString() + "px";
			windowTitle.style.left = (elem_data.left-offsetX).toString() + "px";
			windowTitle.style.top = (elem_data.top-offsetY).toString() + "px";
			windowTitle.style.zIndex = itemCount.toString();
			main.appendChild(windowTitle);
			
			var titleText = document.createElement("p");
			titleText.style.lineHeight = Math.round(titleBarHeight) + "px";
			titleText.style.fontSize = Math.round(titleTextSize) + "px";
			titleText.style.color = "#FFFFFF";
			titleText.style.marginLeft = Math.round(titleBarHeight/4) + "px";
			titleText.textContent = elem_data.title;
			windowTitle.appendChild(titleText);
			
			if(elem_data.type == "screen") return;
			
			var windowItem = document.createElement("div");
			windowItem.id = elem_data.id;
			windowItem.className = "windowItem";
			windowItem.style.left = (elem_data.left-offsetX).toString() + "px";
			windowItem.style.top = (elem_data.top+titleBarHeight-offsetY).toString() + "px";
			windowItem.style.zIndex = (itemCount+1).toString();
			main.appendChild(windowItem);
			
			if(elem_data.type == "img"){
				var img = document.createElement("img");
				img.id = elem_data.id + "_img";
				img.className = "sageItem";
				img.aspectRatio = elem_data.aspect;
				img.width = elem_data.width;
				img.height = elem_data.height;
				img.src = elem_data.src;
				img.draggable = false;
				
				windowItem.appendChild(img);
			}
			else if(elem_data.type == "pdf"){
				var pdf = document.createElement("img");
				pdf.id = elem_data.id + "_pdf"
				pdf.className = "sageItem";
				pdf.aspectRatio = elem_data.aspect;
				pdf.width = elem_data.width;
				pdf.height = elem_data.height;
				
				windowItem.appendChild(pdf);
				
				var pdfData = base64ToUint8Array(elem_data.src);
				var pdfObj = new pdf_canvas();
				pdfObj.init(elem_data.id + "_pdf", pdfData);
				pdfItems[elem_data.id + "_pdf"] = pdfObj;
			}
			else if(elem_data.type == "canvas" || elem_data.type == "webgl"){
				var canvas = document.createElement("canvas");
				canvas.id = elem_data.id + "_canvas"
				canvas.className = "sageItem";
				canvas.aspectRatio = elem_data.aspect;
				canvas.width = elem_data.width;
				canvas.height = elem_data.height;
			
				windowItem.appendChild(canvas);
			
				var canvasJS = document.createElement('script')
				canvasJS.type = "text/javascript";
				canvasJS.src = elem_data.src;
				document.head.appendChild(canvasJS);
			
				canvasJS.addEventListener('load', function(event) {
					var canvasObj = new window[elem_data.extra];
					canvasObj.init(elem_data.id + "_canvas", date, elem_data.resrc);
					canvasObj.draw(date);
					canvasItems[elem_data.id + "_canvas"] = canvasObj;
				}, false);
			}
			else if(elem_data.type == "kineticjs"){
				var kineticjs = document.createElement("div");
				kineticjs.id = elem_data.id + "_kineticjs"
				kineticjs.className = "sageItem";
				kineticjs.aspectRatio = elem_data.aspect;
				kineticjs.width = elem_data.width;
				kineticjs.height = elem_data.height;
			
				windowItem.appendChild(kineticjs);
				
				var kineticjsJS = document.createElement('script')
				kineticjsJS.type = "text/javascript";
				kineticjsJS.src = elem_data.src;
				document.head.appendChild(kineticjsJS);
				
				kineticjsJS.addEventListener('load', function(event) {
					var kineticjsObj = new window[elem_data.extra];
					kineticjsObj.init(elem_data.id + "_kineticjs", date, elem_data.resrc);
					canvasItems[elem_data.id + "_kineticjs"] = kineticjsObj;
				}, false);
			}
			else if(elem_data.type == "threejs"){
				var threejs = document.createElement("div");
				threejs.id = elem_data.id + "_threejs"
				threejs.className = "sageItem";
				threejs.aspectRatio = elem_data.aspect;
				threejs.width = elem_data.width;
				threejs.height = elem_data.height;
			
				windowItem.appendChild(threejs);
				
				var threejsJS = document.createElement('script')
				threejsJS.type = "text/javascript";
				threejsJS.src = elem_data.src;
				document.head.appendChild(threejsJS);
				
				threejsJS.addEventListener('load', function(event) {
					var threejsObj = new window[elem_data.extra];
					threejsObj.init(elem_data.id + "_threejs", date, elem_data.resrc);
					canvasItems[elem_data.id + "_threejs"] = threejsObj;
				}, false);
			}
			else if(elem_data.type == "video" || elem_data.type == "youtube"){
				var vid = document.createElement("video");
				vid.id = elem_data.id + "_video";
				vid.className = "sageItem";
				vid.aspectRatio = elem_data.aspect;
				vid.width = elem_data.width;
				vid.height = elem_data.height;
				vid.controls = false;
				vid.muted = true;
				vid.style.backgroundColor = "#333333";
				if(elem_data.resrc != null) vid.poster = elem_data.resrc;
				
				vid.addEventListener('canplay', function() {
					console.log("video can now play"); // Video is loaded and can be played
				}, false);
				
				console.log(elem_data.src);
				
				var source1 = document.createElement("source");
				var param = elem_data.src.indexOf('?');
				if(param >= 0) source1.src = elem_data.src + "&clientID=" + clientID.toString();
				else source1.src = elem_data.src + "?clientID=" + clientID.toString();
				source1.type = "video/mp4";
				vid.appendChild(source1);
				
				windowItem.appendChild(vid);
			}
            else if(elem_data.type == "site"){       
                var ifrm = document.createElement("IFRAME"); 
                ifrm.id = elem_data.id + "_site"
                ifrm.className = "sageItem";
                ifrm.src = elem_data.src; 
                ifrm.width =  elem_data.width;
                ifrm.height = elem_data.height;
                windowItem.appendChild(ifrm); 
                console.log("iframe source:" + elem_data.src);
            }
			
			itemCount += 2;
		});
		
		socket_io.on('deleteElement', function(elemId) {
			var deleteElemTitle = document.getElementById(elemId + "_title");
			deleteElemTitle.parentNode.removeChild(deleteElemTitle);
			
			var deleteElem = document.getElementById(elemId);
			deleteElem.parentNode.removeChild(deleteElem);
		});
		
		socket_io.on('updateItemOrder', function(idList) {
			var i;
			var zval = 0;
			for(i=0; i<idList.length; i++){
				var selectedElemTitle = document.getElementById(idList[i] + "_title");
				var selectedElem = document.getElementById(idList[i]);
				
				selectedElemTitle.style.zIndex = zval.toString();
				selectedElem.style.zIndex = (zval+1).toString();
				
				zval += 2;
			}
		});
		
		socket_io.on('setItemPosition', function(position_data) {
			var date = new Date(position_data.date);
			
			var eLeft = position_data.elemLeft - offsetX;
			var eTop = position_data.elemTop - offsetY;
			
			var selectedElemTitle = document.getElementById(position_data.elemId + "_title");
			selectedElemTitle.style.left = eLeft.toString() + "px";
			selectedElemTitle.style.top = eTop.toString() + "px";
			
			var selectedElem = document.getElementById(position_data.elemId);
			selectedElem.style.left = eLeft.toString() + "px";
			selectedElem.style.top = (eTop+titleBarHeight).toString() + "px";
		});
		
		socket_io.on('setItemPositionAndSize', function(position_data) {
			var date = new Date(position_data.date);
			
			var eLeft = position_data.elemLeft - offsetX;
			var eTop = position_data.elemTop - offsetY;
			
			var selectedElemTitle = document.getElementById(position_data.elemId + "_title");
			selectedElemTitle.style.left = eLeft.toString() + "px";
			selectedElemTitle.style.top = eTop.toString() + "px";
			selectedElemTitle.style.width = Math.round(position_data.elemWidth).toString() + "px";
			
			var selectedElem = document.getElementById(position_data.elemId);
			selectedElem.style.left = eLeft.toString() + "px";
			selectedElem.style.top = (eTop+titleBarHeight).toString() + "px";
			
			var child = selectedElem.getElementsByClassName("sageItem");
			child[0].width = Math.round(position_data.elemWidth);
			child[0].height = Math.round(position_data.elemHeight);
			
			if(child[0].id.substring(child[0].id.length - 6) == "canvas"){
				canvasItems[child[0].id].draw(date);
			}
			if(child[0].id.substring(child[0].id.length - 9) == "kineticjs"){
				canvasItems[child[0].id].resize(date);
			}
			if(child[0].id.substring(child[0].id.length - 7) == "threejs"){
				canvasItems[child[0].id].resize(date);
			}
		});
		
		socket_io.on('finishedResize', function(elemId) {
			var selectedElem = document.getElementById(elemId);
			
			var child = selectedElem.getElementsByClassName("sageItem");
			
			if(child[0].id.substring(child[0].id.length - 3) == "pdf"){
				pdfItems[child[0].id].renderPage();
			}
		});
		
		socket_io.on('keypressItem', function(keypress_data) {
			var selectedElem = document.getElementById(keypress_data.elemId);
			
			var child = selectedElem.getElementsByClassName("sageItem");
		
			if(keypress_data.keyCode == "32"){ // spacebar
				
			}
			else if(keypress_data.keyCode == "37"){ // left arrow
				if(child[0].id.substring(child[0].id.length - 3) == "pdf"){
					pdfItems[child[0].id].goPrevious();
				}
			}
			else if(keypress_data.keyCode == "39"){ // right arrow
				if(child[0].id.substring(child[0].id.length - 3) == "pdf"){
					pdfItems[child[0].id].goNext();
				}
			}
		});
		
		socket_io.on('updateVideoItemTime', function(video_data) {
			var selectedElem = document.getElementById(video_data.elemId);
			
			var child = selectedElem.getElementsByClassName("sageItem");
			child[0].currentTime = video_data.time;
			
			console.log(video_data.time);
			
			if(video_data.play && child[0].paused) child[0].play();
			else if(!video_data.play) child[0].pause();
		});
		
		socket_io.on('animateCanvas', function(animate_data) {
			var date = new Date(animate_data.date);
			
			var canvasElem = document.getElementById(animate_data.elemId);
			var child = canvasElem.getElementsByClassName("sageItem");
			if(animate_data.type == "canvas" || animate_data.type == "webgl" || animate_data.type == "kineticjs" || animate_data.type == "threejs"){
				canvasItems[child[0].id].draw(date);
			}
		});
	}
	
	function playPauseVideo(elemId) {
		var videoElem = document.getElementById(elemId + "_video");
		if(videoElem.paused == true){ videoElem.play(); console.log("play"); }
		else{ videoElem.pause(); console.log("pause"); }
	}
	
	function moveItemToFront(elem) {
		var last = elem.parentNode.lastChild;
		if(elem != last){
			elem.parentNode.replaceChild(elem, last);
			elem.parentNode.insertBefore(last, elem);
		}
	}

	function base64ToUint8Array(base64) {
        var raw = atob(base64); //This is a native function that decodes a base64-encoded string.
        var uint8Array = new Uint8Array(new ArrayBuffer(raw.length));
        for (var i = 0; i < raw.length; i++) {
            uint8Array[i] = raw.charCodeAt(i);
        }

        return uint8Array;
    }
    
	function getParameterByName(name) {
		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
		return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
</script>

<link rel="stylesheet" type="text/css" href="style.css" media="screen" />

</head>

<body onload="init()">
	<div id="main">
	</div>
</body>
</html>

